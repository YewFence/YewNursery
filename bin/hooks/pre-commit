#!/bin/sh

# è·å–æš‚å­˜åŒºä¸­æˆ‘ä»¬å…³å¿ƒçš„æ–‡ä»¶ (æ’é™¤åˆ é™¤çš„æ–‡ä»¶)
files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ps1|psm1|json|yml|yaml|md|txt)$')

if [ -z "$files" ]; then
    exit 0
fi

# å°†æ¢è¡Œç¬¦è½¬æ¢ä¸ºç©ºæ ¼ï¼Œä»¥ä¾¿ä¼ é€’ç»™ PowerShell
# æ³¨æ„ï¼šå¦‚æœæ–‡ä»¶ååŒ…å«ç©ºæ ¼ï¼Œè¿™é‡Œå¯èƒ½éœ€è¦æ›´å¤æ‚çš„å¤„ç†ï¼Œä½†åœ¨ç®€å•åœºæ™¯ä¸‹é€šå¸¸è¶³å¤Ÿ
file_args=$(echo "$files" | tr '\n' ' ')

echo "ğŸ” Running style check on staged files..."

# æ£€æµ‹å¯ç”¨çš„ PowerShell å‘½ä»¤
if command -v pwsh >/dev/null 2>&1; then
    SHELL_CMD="pwsh"
else
    SHELL_CMD="powershell"
fi

# è°ƒç”¨ä¿®å¤è„šæœ¬ï¼Œä½†å…³é—­è‡ªåŠ¨ä¿®å¤ (-Fix 0)
# æˆ‘ä»¬ä½¿ç”¨ ValueFromRemainingArguments æ¥æ”¶æ–‡ä»¶åˆ—è¡¨ï¼Œæ‰€ä»¥ç›´æ¥è·Ÿåœ¨å‚æ•°åé¢å³å¯
# ä½¿ç”¨ -Fix 0 (ç©ºæ ¼åˆ†éš”) è€Œä¸æ˜¯ -Fix:0ï¼Œä»¥é¿å…åœ¨ -File æ¨¡å¼ä¸‹çš„å‚æ•°è§£æé—®é¢˜
$SHELL_CMD -NoProfile -ExecutionPolicy Bypass -File "./bin/fix-style.ps1" -Fix 0 $file_args

rc=$?
if [ $rc -ne 0 ]; then
    echo ""
    echo "âŒ Style check failed!"
    echo "   Please run: .\bin\fix-style.ps1"
    echo "   Then: git add . && git commit"
    exit 1
fi

exit 0
