on:
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull Request Number'
        required: true
      comment_body:
        description: 'Comment Body (e.g. /verify, /set-bin ...)'
        required: true
permissions:
  contents: write
  pull-requests: write
  issues: write

name: Commented Pull Request

jobs:
  # Existing handler for /verify
  pullRequestHandler:
    name: PullRequestHandler
    runs-on: windows-latest
    if: |
      (github.event.issue.pull_request && startsWith(github.event.comment.body, '/verify')) ||
      (github.event_name == 'workflow_dispatch' && startsWith(inputs.comment_body, '/verify'))
    steps:
      - name: Get PR Info
        id: pr_info
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number || context.payload.inputs.pr_number;
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('head_repo', pr.head.repo.full_name);
            core.setOutput('base_ref', pr.base.ref);

      - uses: actions/checkout@v4
        with:
          repository: ${{ steps.pr_info.outputs.head_repo }}
          ref: ${{ steps.pr_info.outputs.head_ref }}

      - name: PullRequestHandler
        uses: ScoopInstaller/GithubActions@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # New ChatOps handler
  check-syntax:
    name: Check Syntax
    runs-on: ubuntu-latest
    if: |
      (github.event.issue.pull_request &&
       (startsWith(github.event.comment.body, '/set-bin') ||
        startsWith(github.event.comment.body, '/set-shortcut') ||
        startsWith(github.event.comment.body, '/set-persist') ||
        startsWith(github.event.comment.body, '/set-key') ||
        startsWith(github.event.comment.body, '/list-config'))) ||
      (github.event_name == 'workflow_dispatch' &&
       (startsWith(inputs.comment_body, '/set-bin') ||
        startsWith(inputs.comment_body, '/set-shortcut') ||
        startsWith(inputs.comment_body, '/set-persist') ||
        startsWith(inputs.comment_body, '/set-key') ||
        startsWith(inputs.comment_body, '/list-config')))
    steps:
      - name: Get PR Info
        id: pr_info
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number || context.payload.inputs.pr_number;
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('head_repo', pr.head.repo.full_name);
            core.setOutput('base_ref', pr.base.ref);

      - name: Checkout PR (for scripts)
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.pr_info.outputs.head_repo }}
          ref: ${{ steps.pr_info.outputs.head_ref }}
          sparse-checkout: scripts

      - name: Acknowledge Command
        uses: actions/github-script@v7
        env:
          REACTION_CONTENT: eyes
        with:
          script: |
            if (context.eventName === 'workflow_dispatch') {
              console.log('Skipping acknowledgment reaction for workflow_dispatch');
              return;
            }
            const script = require('./scripts/github/add-reaction.js');
            await script({github, context, core});

      - name: Validate Command Syntax
        uses: actions/github-script@v7
        env:
            COMMENT_BODY: ${{ github.event.comment.body || inputs.comment_body }}
        with:
          script: |
            const script = require('./scripts/github/validate-syntax.js');
            
            if (context.eventName === 'workflow_dispatch') {
                // Mock payload
                context.payload.comment = { 
                    body: process.env.COMMENT_BODY,
                    id: 1 
                };
                
                // Mock context.issue
                Object.defineProperty(context, 'issue', {
                    get: () => ({ owner: context.repo.owner, repo: context.repo.repo, number: parseInt(context.payload.inputs.pr_number) })
                });

                // Mock reactions API
                github.rest.reactions.createForIssueComment = async (args) => {
                    console.log(`[Mock] Adding reaction ${args.content} to comment ${args.comment_id}`);
                    return { data: {} };
                };
            }
            await script({github, context, core});

  chatops:
    name: ChatOps
    needs: check-syntax
    runs-on: windows-latest
    steps:
      - name: Get PR Info
        id: pr_info
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number || context.payload.inputs.pr_number;
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('head_repo', pr.head.repo.full_name);
            core.setOutput('base_ref', pr.base.ref);

      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ steps.pr_info.outputs.head_repo }}
          ref: ${{ steps.pr_info.outputs.head_ref }}
          fetch-depth: 0

      - name: Acknowledge Processing
        uses: actions/github-script@v7
        env:
          REACTION_CONTENT: eyes
        with:
          script: |
            if (context.eventName === 'workflow_dispatch') {
              console.log('Skipping acknowledgment reaction for workflow_dispatch');
              return;
            }
            const script = require('./scripts/github/add-reaction.js');
            try { await script({github, context, core}); } catch(e) {}

      - name: Fetch Base Branch
        run: |
          git remote add upstream https://github.com/${{ github.repository }}
          git fetch upstream ${{ steps.pr_info.outputs.base_ref }}

      - name: Checkout Scoop Core (for formatjson)
        uses: actions/checkout@v4
        with:
          repository: ScoopInstaller/Scoop
          path: scoop_core

      - name: Install Scoop
        shell: pwsh
        run: |
          Set-ExecutionPolicy RemoteSigned -Scope CurrentUser
          Invoke-RestMethod -Uri https://get.scoop.sh | Invoke-Expression
          "$env:USERPROFILE\scoop\shims" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Configure Git
        run: |
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      - name: Install Dependencies
        shell: pwsh
        run: |
          scoop install jq 7zip

      - name: Process Command
        id: process_cmd
        shell: pwsh
        env:
          SCOOP_HOME: ${{ github.workspace }}\scoop_core
          COMMENT_BODY: ${{ github.event.comment.body || inputs.comment_body }}
          CHAT_BASE_REF: upstream/${{ steps.pr_info.outputs.base_ref }}
        run: |
          ./scripts/invoke-chatops.ps1

      - name: Format JSON
        shell: pwsh
        env:
          SCOOP_HOME: ${{ github.workspace }}\scoop_core
        run: |
          ./bin/formatjson.ps1

      - name: Commit and Push
        run: |
          git add bucket/*.json
          # Check if there are changes
          git diff --staged --quiet || git commit -m "chore: update manifest via chatops"
          git push

      - name: Report Success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            if (context.eventName === 'workflow_dispatch') {
                context.payload.comment = { id: 1 };
                Object.defineProperty(context, 'issue', {
                    get: () => ({ owner: context.repo.owner, repo: context.repo.repo, number: parseInt(context.payload.inputs.pr_number) })
                });
                github.rest.reactions.createForIssueComment = async () => ({ data: {} });
            }
            const script = require('./scripts/github/report-success.js');
            await script({github, context, core});

      - name: Report Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            if (context.eventName === 'workflow_dispatch') {
                context.payload.comment = { id: 1 };
                Object.defineProperty(context, 'issue', {
                    get: () => ({ owner: context.repo.owner, repo: context.repo.repo, number: parseInt(context.payload.inputs.pr_number) })
                });
                github.rest.reactions.createForIssueComment = async () => ({ data: {} });
            }
            const script = require('./scripts/github/report-failure.js');
            await script({github, context, core});
