#!/bin/sh

# è·å–æš‚å­˜åŒºä¸­æˆ‘ä»¬å…³å¿ƒçš„æ–‡ä»¶ (æ’é™¤åˆ é™¤çš„æ–‡ä»¶)
if ! git diff --cached --name-only --diff-filter=ACM -z | grep -z -q -E '\.(ps1|psm1|json|yml|yaml|md|txt|js)$'; then
    exit 0
fi

echo "ğŸ” Running style check on staged files..."

# æ£€æµ‹å¯ç”¨çš„ PowerShell å‘½ä»¤
if command -v pwsh >/dev/null 2>&1; then
    SHELL_CMD="pwsh"
else
    SHELL_CMD="powershell"
fi

# è°ƒç”¨ä¿®å¤è„šæœ¬ï¼Œä½†å…³é—­è‡ªåŠ¨ä¿®å¤ (-Fix $false)
# æˆ‘ä»¬ä½¿ç”¨ ValueFromRemainingArguments æ¥æ”¶æ–‡ä»¶åˆ—è¡¨ï¼Œæ‰€ä»¥ç›´æ¥è·Ÿåœ¨å‚æ•°åé¢å³å¯
git diff --cached --name-only --diff-filter=ACM -z \
    | grep -z -E '\.(ps1|psm1|json|yml|yaml|md|txt|js)$' \
    | xargs -0 -r $SHELL_CMD -NoProfile -ExecutionPolicy Bypass -Command "& './bin/fix-style.ps1' -Fix \$false"

rc=$?
if [ $rc -ne 0 ]; then
    echo ""
    echo "âŒ Style check failed!"
    echo "   Please run: .\bin\fix-style.ps1"
    echo "   Then: git add . && git commit"
    exit 1
fi

exit 0
