on:
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Pull Request Number'
        required: true
      comment_body:
        description: 'Comment Body (e.g. /verify, /set-bin ...)'
        required: true
permissions:
  contents: write
  pull-requests: write
  issues: write

name: Commented Pull Request

jobs:
  # Existing handler for /verify (Keep on Windows for compatibility with checkver if needed)
  pullRequestHandler:
    name: PullRequestHandler
    runs-on: windows-latest
    if: |
      (github.event.issue.pull_request && startsWith(github.event.comment.body, '/verify')) ||
      (github.event_name == 'workflow_dispatch' && startsWith(inputs.comment_body, '/verify'))
    steps:
      - name: Get PR Info
        id: pr_info
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number || context.payload.inputs.pr_number;
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('head_repo', pr.head.repo.full_name);
            core.setOutput('base_ref', pr.base.ref);

      - uses: actions/checkout@v4
        with:
          repository: ${{ steps.pr_info.outputs.head_repo }}
          ref: ${{ steps.pr_info.outputs.head_ref }}

      - name: PullRequestHandler
        uses: ScoopInstaller/GithubActions@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Refactored ChatOps handler running on Linux
  chatops:
    name: ChatOps
    runs-on: ubuntu-latest
    if: |
      (github.event.issue.pull_request && startsWith(github.event.comment.body, '/')) ||
      (github.event_name == 'workflow_dispatch' && startsWith(inputs.comment_body, '/'))
    steps:
      - name: Acknowledge Command
        uses: actions/github-script@v7
        env:
          REACTION_CONTENT: eyes
        with:
          script: |
            if (context.eventName === 'workflow_dispatch') return;
            const reaction = process.env.REACTION_CONTENT || 'eyes';
            try {
              await github.rest.reactions.createForIssueComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: context.payload.comment.id,
                content: reaction
              });
              console.log(`Added '${reaction}' reaction.`);
            } catch (error) {
              console.error('Failed to add reaction:', error);
            }

      - name: Get PR Info
        id: pr_info
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number || context.payload.inputs.pr_number;
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('head_repo', pr.head.repo.full_name);
            core.setOutput('base_ref', pr.base.ref);
            core.setOutput('head_sha', pr.head.sha);
            core.setOutput('base_sha', pr.base.sha);

      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ steps.pr_info.outputs.head_repo }}
          ref: ${{ steps.pr_info.outputs.head_ref }}
          fetch-depth: 2

      - name: Fetch Base History
        shell: bash
        run: |
          # Fetch base branch history to ensure diff works
          # Useful for fork PRs where base commit might not be in the fork's shallow checkout
          HEAD_REPO="${{ steps.pr_info.outputs.head_repo }}"
          BASE_REPO="${{ github.repository }}"
          BASE_REF="${{ steps.pr_info.outputs.base_ref }}"

          if [ "$HEAD_REPO" != "$BASE_REPO" ]; then
            git remote add base_repo https://github.com/$BASE_REPO
            git fetch base_repo $BASE_REF --depth=50
          else
            git fetch origin $BASE_REF --depth=50
          fi

      - name: Validate Command Syntax
        uses: actions/github-script@v7
        env:
          COMMENT_BODY: ${{ github.event.comment.body || inputs.comment_body }}
          PR_NUMBER: ${{ github.event.issue.number || inputs.pr_number }}
        with:
          script: |
            const script = require('./scripts/github/chatops-validate-runner.js');
            await script({ github, context, core });

      - name: Checkout Scoop Core (for formatjson)
        uses: actions/checkout@v4
        with:
          repository: ScoopInstaller/Scoop
          path: scoop_core

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: bucket/*.json
          sha: ${{ steps.pr_info.outputs.head_sha }}
          base_sha: ${{ steps.pr_info.outputs.base_sha }}

      - name: Resolve Target Manifest
        id: resolve_manifest
        shell: pwsh
        env:
          ALL_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
          COMMENT_BODY: ${{ github.event.comment.body || inputs.comment_body }}
        run: ./scripts/resolve-manifest.ps1 -CommentBody $env:COMMENT_BODY -AllChangedFiles $env:ALL_FILES

      - name: Process Command
        shell: pwsh
        env:
          SCOOP_HOME: ${{ github.workspace }}/scoop_core
          COMMENT_BODY: ${{ github.event.comment.body || inputs.comment_body }}
          REPORT_FILE: chatops-report.md
          LOG_FILE: chatops.log
        run: ./scripts/invoke-chatops.ps1

      - name: Format JSON
        shell: pwsh
        env:
          SCOOP_HOME: ${{ github.workspace }}/scoop_core
        run: ./bin/formatjson.ps1

      - name: Commit changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update manifest via chatops"
          file_pattern: 'bucket/*.json'
          commit_user_name: "github-actions[bot]"
          commit_user_email: "41898282+github-actions[bot]@users.noreply.github.com"
          commit_author: "github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"

      - name: Report Success
        if: success()
        uses: actions/github-script@v7
        env:
          COMMENT_BODY: ${{ github.event.comment.body || inputs.comment_body }}
          PR_NUMBER: ${{ github.event.issue.number || inputs.pr_number }}
          CHATOPS_REPORT_TYPE: success
        with:
          script: |
            const script = require('./scripts/github/chatops-report-runner.js');
            await script({ github, context, core });

      - name: Report Failure
        if: failure()
        uses: actions/github-script@v7
        env:
          COMMENT_BODY: ${{ github.event.comment.body || inputs.comment_body }}
          PR_NUMBER: ${{ github.event.issue.number || inputs.pr_number }}
          CHATOPS_REPORT_TYPE: failure
        with:
          script: |
            const script = require('./scripts/github/chatops-report-runner.js');
            await script({ github, context, core });
