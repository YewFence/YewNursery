on:
  issue_comment:
    types: [created]
permissions:
  contents: write
  pull-requests: write
  issues: write

name: Commented Pull Request

jobs:
  # Existing handler for /verify
  pullRequestHandler:
    name: PullRequestHandler
    runs-on: windows-latest
    if: startsWith(github.event.comment.body, '/verify')
    steps:
      - uses: actions/checkout@main
      - name: PullRequestHandler
        uses: ScoopInstaller/GithubActions@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # New ChatOps handler
  chatops:
    name: ChatOps
    runs-on: windows-latest
    if: |
      github.event.issue.pull_request &&
      (startsWith(github.event.comment.body, '/set-bin') ||
       startsWith(github.event.comment.body, '/set-shortcut') ||
       startsWith(github.event.comment.body, '/set-persist') ||
       startsWith(github.event.comment.body, '/set-key'))
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: refs/pull/${{ github.event.issue.number }}/head
          fetch-depth: 0

      - name: Ensure Main is fetched
        run: git fetch origin main

      - name: Checkout Scoop Core (for formatjson)
        uses: actions/checkout@v4
        with:
          repository: ScoopInstaller/Scoop
          path: scoop_core

      - name: Configure Git
        run: |
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      - name: Process Command
        shell: pwsh
        env:
          SCOOP_HOME: ${{ github.workspace }}\scoop_core
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          $body = $env:COMMENT_BODY
          # Extract command and args. Assuming one command per comment line or just first line.
          # We take the first line that starts with /
          $line = $body -split "`n" | Where-Object { $_ -match '^/' } | Select-Object -First 1

          if ($line -match '^(\/[^\s]+)\s+(.*)$') {
              $cmd = $Matches[1]
              $argsLine = $Matches[2]
          } elseif ($line -match '^(\/[^\s]+)$') {
              $cmd = $Matches[1]
              $argsLine = ""
          }

          if ($cmd) {
              Write-Host "Executing: $cmd $argsLine"
              ./scripts/pr-chatops.ps1 -Command $cmd -ArgsLine $argsLine
          }

      - name: Format JSON
        shell: pwsh
        env:
          SCOOP_HOME: ${{ github.workspace }}\scoop_core
        run: |
          ./bin/formatjson.ps1

      - name: Commit and Push
        run: |
          git add bucket/*.json
          # Check if there are changes
          git diff --staged --quiet || git commit -m "chore: update manifest via chatops"
          git push
